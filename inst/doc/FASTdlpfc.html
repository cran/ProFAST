<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Wei Liu" />

<meta name="date" content="2024-03-18" />

<title>FAST: single DLPFC section</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">FAST: single DLPFC section</h1>
<h4 class="author">Wei Liu</h4>
<h4 class="date">2024-03-18</h4>



<p>This vignette introduces the FAST workflow for the analysis of single-section rather than multi-secitons data, one humn dorsolateral prefrontal cortex (DLPFC) spatial transcriptomics dataset. In this vignette, the workflow of FAST consists of three steps</p>
<ul>
<li>Independent preprocessing</li>
<li>Spatial dimension reduction using FAST</li>
<li>Downstream analysis (i.e.Â , embedding alignment and spatial clustering using iSC-MEB, visualization of clusters and embeddings, remove unwanted variation, differential expression analysis)</li>
</ul>
<p>We demonstrate the use of FAST to one DLPFC Visium data that are <a href="https://github.com/feiyoung/ProFAST/tree/main/vignettes_data">here</a>, which can be downloaded to the current working path by the following command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">githubURL &lt;-<span class="st"> &quot;https://github.com/feiyoung/FAST/blob/main/vignettes_data/seulist2_ID9_10.RDS?raw=true&quot;</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">download.file</span>(githubURL,<span class="st">&quot;seulist2_ID9_10.RDS&quot;</span>,<span class="dt">mode=</span><span class="st">&#39;wb&#39;</span>)</a></code></pre></div>
<p>Then load to R. Here, we only focus one section.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">dlpfc2 &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;./seulist2_ID9_10.RDS&quot;</span>)</a>
<a class="sourceLine" id="cb2-2" title="2">dlpfc &lt;-<span class="st"> </span>dlpfc2[[<span class="dv">1</span>]]</a></code></pre></div>
<p>The package can be loaded with the command:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">library</span>(ProFAST) <span class="co"># load the package of FAST method</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">library</span>(PRECAST)</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">library</span>(Seurat)</a></code></pre></div>
<div id="view-the-dlpfc-data" class="section level2">
<h2>View the DLPFC data</h2>
<p>First, we view the the spatial transcriptomics data with Visium platform. There are ~15000 genes and ~3600 spots.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">dlpfc <span class="co">## a list including three Seurat object with default assay: RNA</span></a></code></pre></div>
<p>We observed that the genes are Ensembl IDs. In the following, we will transfer the Ensembl IDs to gene symbols for matching the housekeeping genes in the downstream analysis for removing the unwanted variations.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">print</span>(<span class="kw">row.names</span>(dlpfc)[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>])</a>
<a class="sourceLine" id="cb5-2" title="2">count &lt;-<span class="st"> </span>dlpfc[[<span class="st">&#39;RNA&#39;</span>]]<span class="op">@</span>counts</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">row.names</span>(count) &lt;-<span class="st"> </span><span class="kw">unname</span>(<span class="kw">transferGeneNames</span>(<span class="kw">row.names</span>(count), <span class="dt">now_name =</span> <span class="st">&quot;ensembl&quot;</span>,</a>
<a class="sourceLine" id="cb5-4" title="4">                                                 <span class="dt">to_name=</span><span class="st">&quot;symbol&quot;</span>,</a>
<a class="sourceLine" id="cb5-5" title="5">                                                 <span class="dt">species=</span><span class="st">&quot;Human&quot;</span>, <span class="dt">Method=</span><span class="st">&#39;eg.db&#39;</span>))</a>
<a class="sourceLine" id="cb5-6" title="6"><span class="kw">print</span>(<span class="kw">row.names</span>(count)[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>])</a>
<a class="sourceLine" id="cb5-7" title="7">seu &lt;-<span class="st"> </span><span class="kw">CreateSeuratObject</span>(<span class="dt">counts =</span> count, <span class="dt">meta.data =</span> dlpfc<span class="op">@</span>meta.data)</a>
<a class="sourceLine" id="cb5-8" title="8">seu</a></code></pre></div>
</div>
<div id="preprocessing" class="section level2">
<h2>Preprocessing</h2>
<p>We show how to preprocessing before fitting FAST, including log-normalization (if user use the gaussian version of FAST), and select highly variable genes.</p>
<ul>
<li>Note: the spatial coordinates must be contained in the meta data and named as <code>row</code> and <code>col</code>, which benefits the identification of spaital coordinates by FAST.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co">## Check the spatial coordinates: they are named as &quot;row&quot; and &quot;col&quot;!</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">print</span>(<span class="kw">head</span>(seu<span class="op">@</span>meta.data))</a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">seu &lt;-<span class="st"> </span><span class="kw">NormalizeData</span>(seu)</a>
<a class="sourceLine" id="cb7-2" title="2">seu &lt;-<span class="st"> </span><span class="kw">FindVariableFeatures</span>(seu)</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">print</span>(seu)</a>
<a class="sourceLine" id="cb7-4" title="4"><span class="kw">print</span>(seu[[<span class="st">&#39;RNA&#39;</span>]]<span class="op">@</span>var.features[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>])</a></code></pre></div>
<details>
<p><summary><strong>Find spatially variable genes</strong></summary> Users can also use the spatially variable genes by the following command:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">set.seed</span>(<span class="dv">2023</span>)</a>
<a class="sourceLine" id="cb8-2" title="2">seu &lt;-<span class="st"> </span>DR.SC<span class="op">::</span><span class="kw">FindSVGs</span>(seu)</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">### Check the results</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="kw">print</span>(seu[[<span class="st">&#39;RNA&#39;</span>]]<span class="op">@</span>var.features[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>])</a></code></pre></div>
</details>
</div>
<div id="fit-fast-for-this-data" class="section level2">
<h2>Fit FAST for this data</h2>
<p>For function <code>FAST_single</code>, users can specify the number of factors <code>q</code> and the fitted model <code>fit.model</code>. The <code>q</code> sets the number of spatial factors to be extracted, and a lareger one means more information to be extracted but higher computaional cost. The <code>fit.model</code> specifies the version of FAST to be fitted. The Gaussian version (<code>gaussian</code>) models the log-normalized matrix while the Poisson verion (<code>poisson</code>) models the count matrix; default as <code>poisson</code>. (Note: The computational time required to run the analysis on personal PCs is approximately ~0.5 minute on a personal PC.)</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">Adj_sp &lt;-<span class="st"> </span><span class="kw">AddAdj</span>(<span class="kw">as.matrix</span>(seu<span class="op">@</span>meta.data[,<span class="kw">c</span>(<span class="st">&quot;row&quot;</span>, <span class="st">&quot;col&quot;</span>)]), <span class="dt">platform =</span> <span class="st">&quot;Visium&quot;</span>)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">### set q= 15 here</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="kw">set.seed</span>(<span class="dv">2023</span>)</a>
<a class="sourceLine" id="cb9-4" title="4">seu &lt;-<span class="st"> </span><span class="kw">FAST_single</span>(seu, <span class="dt">Adj_sp=</span>Adj_sp, <span class="dt">q=</span> <span class="dv">15</span>, <span class="dt">fit.model=</span><span class="st">&#39;poisson&#39;</span>)</a>
<a class="sourceLine" id="cb9-5" title="5">seu</a></code></pre></div>
<details>
<p><summary><strong>Run possion version</strong></summary> Users can also use the gaussian version by the following command:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">Adj_sp &lt;-<span class="st"> </span><span class="kw">AddAdj</span>(<span class="kw">as.matrix</span>(seu<span class="op">@</span>meta.data[,<span class="kw">c</span>(<span class="st">&quot;row&quot;</span>, <span class="st">&quot;col&quot;</span>)]), <span class="dt">platform =</span> <span class="st">&quot;Visium&quot;</span>)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">set.seed</span>(<span class="dv">2023</span>)</a>
<a class="sourceLine" id="cb10-3" title="3">seu &lt;-<span class="st"> </span><span class="kw">FAST_single</span>(dlpfc, <span class="dt">Adj_sp=</span>Adj_sp, <span class="dt">q=</span> <span class="dv">15</span>, <span class="dt">fit.model=</span><span class="st">&#39;gaussian&#39;</span>)</a>
<a class="sourceLine" id="cb10-4" title="4"><span class="co">### Check the results</span></a>
<a class="sourceLine" id="cb10-5" title="5">seu</a></code></pre></div>
</details>
<div id="evaluate-the-adjusted-mcfaddens-pseudo-r-square" class="section level3">
<h3>Evaluate the adjusted McFaddenâs pseudo R-square</h3>
<p>Next, we investigate the performance of dimension reduction by calculating the adjusted McFaddenâs pseudo R-square. The manual annotations are regarded as the ground truth in the <code>meta.data</code> of <code>seu</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co">## Obtain the true labels</span></a>
<a class="sourceLine" id="cb11-2" title="2">y &lt;-<span class="st"> </span>seu<span class="op">$</span>layer_guess_reordered</a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co">### Evaluate the MacR2</span></a>
<a class="sourceLine" id="cb11-4" title="4">Mac &lt;-<span class="st">  </span><span class="kw">get_r2_mcfadden</span>(<span class="kw">Embeddings</span>(seu, <span class="dt">reduction=</span><span class="st">&#39;fast&#39;</span>), y)</a>
<a class="sourceLine" id="cb11-5" title="5"><span class="co">### output them</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="kw">print</span>(<span class="kw">paste0</span>(<span class="st">&quot;MacFadden&#39;s R-square of FAST is &quot;</span>, <span class="kw">round</span>(Mac, <span class="dv">3</span>)))</a></code></pre></div>
</div>
</div>
<div id="clustering-analysis-based-on-fast-embedding" class="section level2">
<h2>Clustering analysis based on FAST embedding</h2>
<p>Based on the embeddings from FAST, we use <code>Louvain</code> to perform clustering. In this downstream analysis, other methods for clustering can be also used.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">seu &lt;-<span class="st"> </span><span class="kw">FindNeighbors</span>(seu, <span class="dt">reduction =</span> <span class="st">&#39;fast&#39;</span>)</a>
<a class="sourceLine" id="cb12-2" title="2">seu &lt;-<span class="st"> </span><span class="kw">FindClusters</span>(seu, <span class="dt">resolution =</span> <span class="fl">0.4</span>)</a>
<a class="sourceLine" id="cb12-3" title="3">seu<span class="op">$</span>fast.cluster &lt;-<span class="st"> </span>seu<span class="op">$</span>seurat_clusters</a>
<a class="sourceLine" id="cb12-4" title="4">ARI.fast &lt;-<span class="st"> </span>mclust<span class="op">::</span><span class="kw">adjustedRandIndex</span>(y, seu<span class="op">$</span>fast.cluster)</a>
<a class="sourceLine" id="cb12-5" title="5"><span class="kw">print</span>(<span class="kw">paste0</span>(<span class="st">&quot;ARI of PCA is &quot;</span>, <span class="kw">round</span>(ARI.fast, <span class="dv">3</span>)))</a></code></pre></div>
<p>For comparison, we also run PCA to obtain PCA embeddings, and then conduct louvain clustering.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">seu &lt;-<span class="st"> </span><span class="kw">ScaleData</span>(seu)</a>
<a class="sourceLine" id="cb13-2" title="2">seu &lt;-<span class="st"> </span><span class="kw">RunPCA</span>(seu, <span class="dt">npcs=</span><span class="dv">15</span>, <span class="dt">verbose=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-3" title="3">Mac.pca &lt;-<span class="st"> </span><span class="kw">get_r2_mcfadden</span>(<span class="kw">Embeddings</span>(seu, <span class="dt">reduction=</span><span class="st">&#39;pca&#39;</span>), y)</a>
<a class="sourceLine" id="cb13-4" title="4"><span class="kw">print</span>(<span class="kw">paste0</span>(<span class="st">&quot;MacFadden&#39;s R-square of PCA is &quot;</span>, <span class="kw">round</span>(Mac.pca, <span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb13-5" title="5"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb13-6" title="6">seu &lt;-<span class="st"> </span><span class="kw">FindNeighbors</span>(seu, <span class="dt">reduction =</span> <span class="st">&#39;pca&#39;</span>, <span class="dt">graph.name =</span><span class="st">&quot;pca.graph&quot;</span>)</a>
<a class="sourceLine" id="cb13-7" title="7">seu &lt;-<span class="st"> </span><span class="kw">FindClusters</span>(seu, <span class="dt">resolution =</span> <span class="fl">0.8</span>,<span class="dt">graph.name =</span> <span class="st">&#39;pca.graph&#39;</span>) </a>
<a class="sourceLine" id="cb13-8" title="8">seu<span class="op">$</span>pca.cluster &lt;-<span class="st"> </span>seu<span class="op">$</span>seurat_clusters</a>
<a class="sourceLine" id="cb13-9" title="9">ARI.pca &lt;-<span class="st"> </span>mclust<span class="op">::</span><span class="kw">adjustedRandIndex</span>(y, seu<span class="op">$</span>pca.cluster)</a>
<a class="sourceLine" id="cb13-10" title="10"><span class="kw">print</span>(<span class="kw">paste0</span>(<span class="st">&quot;ARI of PCA is &quot;</span>, <span class="kw">round</span>(ARI.pca, <span class="dv">3</span>)))</a></code></pre></div>
</div>
<div id="visualization" class="section level2">
<h2>Visualization</h2>
<p>First, user can choose a beautiful color schema using <code>chooseColors()</code> in the R package <code>PRECAST</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">cols_cluster &lt;-<span class="st"> </span><span class="kw">chooseColors</span>(<span class="dt">palettes_name =</span> <span class="st">&quot;Nature 10&quot;</span>, <span class="dt">n_colors =</span> <span class="dv">8</span>, <span class="dt">plot_colors =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>Then, we plot the spatial scatter plot for clusters using the function <code>DimPlot()</code> in the R package <code>Seurat</code>. We observe that the clusters from PCA are more messy while the clusters from FAST are more smoothing in spatial coordinates.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">seu &lt;-<span class="st"> </span>PRECAST<span class="op">::</span><span class="kw">Add_embed</span>(<span class="dt">embed =</span> <span class="kw">as.matrix</span>(seu<span class="op">@</span>meta.data[,<span class="kw">c</span>(<span class="st">&quot;row&quot;</span>, <span class="st">&quot;col&quot;</span>)]), seu, <span class="dt">embed_name =</span> <span class="st">&#39;Spatial&#39;</span>)</a>
<a class="sourceLine" id="cb15-2" title="2">seu</a>
<a class="sourceLine" id="cb15-3" title="3">p1 &lt;-<span class="st"> </span><span class="kw">DimPlot</span>(seu, <span class="dt">reduction =</span> <span class="st">&#39;Spatial&#39;</span>, <span class="dt">group.by =</span> <span class="st">&#39;pca.cluster&#39;</span>,<span class="dt">cols =</span> cols_cluster, <span class="dt">pt.size =</span> <span class="fl">1.5</span>)</a>
<a class="sourceLine" id="cb15-4" title="4">p2 &lt;-<span class="st"> </span><span class="kw">DimPlot</span>(seu, <span class="dt">reduction =</span> <span class="st">&#39;Spatial&#39;</span>, <span class="dt">group.by =</span> <span class="st">&#39;fast.cluster&#39;</span>,<span class="dt">cols =</span> cols_cluster, <span class="dt">pt.size =</span> <span class="fl">1.5</span>)</a>
<a class="sourceLine" id="cb15-5" title="5"><span class="kw">drawFigs</span>(<span class="kw">list</span>(p1, p2),<span class="dt">layout.dim =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>) )</a></code></pre></div>
<p>Next, we visualize the clusters from <code>FAST</code> on the UMAP space, and observe the clusters are well separated in general.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">seu &lt;-<span class="st"> </span><span class="kw">RunUMAP</span>(seu, <span class="dt">reduction =</span> <span class="st">&quot;fast&quot;</span>, <span class="dt">dims=</span><span class="dv">1</span><span class="op">:</span><span class="dv">15</span>)</a>
<a class="sourceLine" id="cb16-2" title="2">seu</a>
<a class="sourceLine" id="cb16-3" title="3"><span class="kw">DimPlot</span>(seu, <span class="dt">reduction=</span><span class="st">&#39;umap&#39;</span>, <span class="dt">group.by =</span> <span class="st">&quot;fast.cluster&quot;</span>)</a></code></pre></div>
</div>
<div id="differential-epxression-analysis" class="section level2">
<h2>Differential epxression analysis</h2>
<p>Finally, we condut the differential expression (DE) analysis. The function <code>FindAllMarkers()</code> in the <code>Seurat</code> R package is ued to achieve this analysis. And we extract the top five DE genes.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">Idents</span>(seu) &lt;-<span class="st"> </span>seu<span class="op">$</span>fast.cluster</a>
<a class="sourceLine" id="cb17-2" title="2">dat_deg &lt;-<span class="st"> </span><span class="kw">FindAllMarkers</span>(seu)</a>
<a class="sourceLine" id="cb17-3" title="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb17-4" title="4">n &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb17-5" title="5">dat_deg <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="st">    </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-7" title="7"><span class="st">    </span><span class="kw">top_n</span>(<span class="dt">n =</span> n, <span class="dt">wt =</span> avg_log2FC) -&gt;<span class="st"> </span>top5</a>
<a class="sourceLine" id="cb17-8" title="8">top5</a></code></pre></div>
<details>
<p><summary><strong>Session Info</strong></summary></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">sessionInfo</span>()</a>
<a class="sourceLine" id="cb18-2" title="2"><span class="co">#&gt; R version 4.2.1 (2022-06-23 ucrt)</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="co">#&gt; Platform: x86_64-w64-mingw32/x64 (64-bit)</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="co">#&gt; Running under: Windows 10 x64 (build 22621)</span></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="co">#&gt; Matrix products: default</span></a>
<a class="sourceLine" id="cb18-7" title="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-8" title="8"><span class="co">#&gt; locale:</span></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="co">#&gt; [1] LC_COLLATE=C                               </span></a>
<a class="sourceLine" id="cb18-10" title="10"><span class="co">#&gt; [2] LC_CTYPE=Chinese (Simplified)_China.utf8   </span></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="co">#&gt; [3] LC_MONETARY=Chinese (Simplified)_China.utf8</span></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="co">#&gt; [4] LC_NUMERIC=C                               </span></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="co">#&gt; [5] LC_TIME=Chinese (Simplified)_China.utf8    </span></a>
<a class="sourceLine" id="cb18-14" title="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-15" title="15"><span class="co">#&gt; attached base packages:</span></a>
<a class="sourceLine" id="cb18-16" title="16"><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></a>
<a class="sourceLine" id="cb18-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-18" title="18"><span class="co">#&gt; loaded via a namespace (and not attached):</span></a>
<a class="sourceLine" id="cb18-19" title="19"><span class="co">#&gt;  [1] digest_0.6.33   R6_2.5.1        jsonlite_1.8.7  evaluate_0.21  </span></a>
<a class="sourceLine" id="cb18-20" title="20"><span class="co">#&gt;  [5] cachem_1.0.8    rlang_1.1.1     cli_3.4.1       rstudioapi_0.14</span></a>
<a class="sourceLine" id="cb18-21" title="21"><span class="co">#&gt;  [9] jquerylib_0.1.4 bslib_0.5.0     rmarkdown_2.23  tools_4.2.1    </span></a>
<a class="sourceLine" id="cb18-22" title="22"><span class="co">#&gt; [13] xfun_0.39       yaml_2.3.7      fastmap_1.1.1   compiler_4.2.1 </span></a>
<a class="sourceLine" id="cb18-23" title="23"><span class="co">#&gt; [17] htmltools_0.5.5 knitr_1.43      sass_0.4.7</span></a></code></pre></div>
</details>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
