<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Wei Liu" />

<meta name="date" content="2024-03-18" />

<title>FAST: simulation</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">FAST: simulation</h1>
<h4 class="author">Wei Liu</h4>
<h4 class="date">2024-03-18</h4>



<p>This vignette introduces the FAST workflow for the analysis of multiple simulated spatial transcriptomics dataset. FAST workflow is based on the PRECASTObj object created in the <code>PRECAST</code> R package and the workflow of FAST is similar to that of PRECAST; see (<a href="https://feiyoung.github.io/PRECAST/articles/PRECAST.BreastCancer.html" class="uri">https://feiyoung.github.io/PRECAST/articles/PRECAST.BreastCancer.html</a>) for the workflow of PRECAST. The workflow of FAST consists of three steps</p>
<ul>
<li>Independent preprocessing and model setting</li>
<li>Spatial dimension reduction using FAST</li>
<li>Downstream analysis (i.e.Â , embedding alignment using Harmony and clustering using Louvain, visualization of clusters and embeddings, remove unwanted variation, combined differential expression analysis)</li>
<li>Except for the above downstream analyses, cell-cell interaction analysis and trajectory inference can also be performed on the basis of the embeddings obtained by FAST.</li>
</ul>
<p>We demonstrate the use of FAST to three simulated ST data that are <a href="https://github.com/feiyoung/ProFAST/tree/main/vignettes_data">here</a>, which can be downloaded to the current working path by the following command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">githubURL &lt;-<span class="st"> &quot;https://github.com/feiyoung/ProFAST/blob/main/vignettes_data/simu3.rds?raw=true&quot;</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">download.file</span>(githubURL,<span class="st">&quot;simu3.rds&quot;</span>,<span class="dt">mode=</span><span class="st">&#39;wb&#39;</span>)</a></code></pre></div>
<p>Then load to R</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">load</span>(<span class="st">&quot;simu3.rds&quot;</span>)</a></code></pre></div>
<p>The package can be loaded with the command:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">library</span>(ProFAST) <span class="co"># load the package of FAST method</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">library</span>(PRECAST)</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">library</span>(Seurat)</a></code></pre></div>
<div id="view-the-simulated-data" class="section level2">
<h2>View the simulated data</h2>
<p>First, we view the the three simulated spatial transcriptomics data with ST platform. There are 200 genes for each data batch and ~2000 spots in total</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">simu3 <span class="co">## a list including three Seurat object with default assay: RNA</span></a></code></pre></div>
<p>Check the content in <code>simu3</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">head</span>(simu3[[<span class="dv">1</span>]])</a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">row.names</span>(simu3[[<span class="dv">1</span>]])[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</a></code></pre></div>
</div>
<div id="create-a-precastobject-object" class="section level2">
<h2>Create a PRECASTObject object</h2>
<p>We show how to create a PRECASTObject object step by step. First, we create a Seurat list object using the count matrix and meta data of each data batch. Although <code>simu3</code> is a prepared Seurat list object, we re-create a same objcet seuList to show the details.</p>
<ul>
<li>Note: the spatial coordinates must be contained in the meta data and named as <code>row</code> and <code>col</code>, which benefits the identification of spaital coordinates by FAST</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co">## Get the gene-by-spot read count matrices</span></a>
<a class="sourceLine" id="cb7-2" title="2">countList &lt;-<span class="st"> </span><span class="kw">lapply</span>(simu3, <span class="cf">function</span>(x) x[[<span class="st">&quot;RNA&quot;</span>]]<span class="op">@</span>counts)</a>
<a class="sourceLine" id="cb7-3" title="3"></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">## Check the spatial coordinates: Yes, they are named as &quot;row&quot; and &quot;col&quot;!</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="kw">head</span>(simu3[[<span class="dv">1</span>]]<span class="op">@</span>meta.data)</a>
<a class="sourceLine" id="cb7-6" title="6"></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="co">## Get the meta data of each spot for each data batch</span></a>
<a class="sourceLine" id="cb7-8" title="8">metadataList &lt;-<span class="st"> </span><span class="kw">lapply</span>(simu3, <span class="cf">function</span>(x) x<span class="op">@</span>meta.data)</a>
<a class="sourceLine" id="cb7-9" title="9"></a>
<a class="sourceLine" id="cb7-10" title="10"></a>
<a class="sourceLine" id="cb7-11" title="11"><span class="co">## ensure the row.names of metadata in metaList are the same as that of colnames count matrix in countList</span></a>
<a class="sourceLine" id="cb7-12" title="12">M &lt;-<span class="st"> </span><span class="kw">length</span>(countList)</a>
<a class="sourceLine" id="cb7-13" title="13"><span class="cf">for</span>(r <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>M){</a>
<a class="sourceLine" id="cb7-14" title="14">  <span class="kw">row.names</span>(metadataList[[r]]) &lt;-<span class="st"> </span><span class="kw">colnames</span>(countList[[r]])</a>
<a class="sourceLine" id="cb7-15" title="15">}</a>
<a class="sourceLine" id="cb7-16" title="16"></a>
<a class="sourceLine" id="cb7-17" title="17"></a>
<a class="sourceLine" id="cb7-18" title="18"><span class="co">## Create the Seurat list  object</span></a>
<a class="sourceLine" id="cb7-19" title="19"></a>
<a class="sourceLine" id="cb7-20" title="20">seuList &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb7-21" title="21"><span class="cf">for</span>(r <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>M){</a>
<a class="sourceLine" id="cb7-22" title="22">  seuList[[r]] &lt;-<span class="st"> </span><span class="kw">CreateSeuratObject</span>(<span class="dt">counts =</span> countList[[r]], <span class="dt">meta.data=</span>metadataList[[r]], <span class="dt">project =</span> <span class="st">&quot;FASTsimu&quot;</span>)</a>
<a class="sourceLine" id="cb7-23" title="23">}</a></code></pre></div>
<div id="prepare-the-precastobject-with-preprocessing-step." class="section level3">
<h3>Prepare the PRECASTObject with preprocessing step.</h3>
<p>Next, we use <code>CreatePRECASTObject()</code> to create a PRECASTObject object based on the Seurat list object <code>seuList</code>. Users are able to see <a href="https://feiyoung.github.io/PRECAST/articles/PRECAST.BreastCancer.html" class="uri">https://feiyoung.github.io/PRECAST/articles/PRECAST.BreastCancer.html</a> for what is done in this function. Since this is a simulated dataset, we used all the 200 genes by using a custom gene list <code>customGenelist=custom_genelist)</code>. We observe that there are only 197 genes passing the filtering step.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">## Create PRECASTObject</span></a>
<a class="sourceLine" id="cb8-3" title="3">custom_genelist &lt;-<span class="st"> </span><span class="kw">row.names</span>(seuList[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb8-4" title="4"><span class="kw">set.seed</span>(<span class="dv">2023</span>)</a>
<a class="sourceLine" id="cb8-5" title="5">PRECASTObj &lt;-<span class="st">  </span><span class="kw">CreatePRECASTObject</span>(seuList, <span class="dt">customGenelist=</span>custom_genelist)</a>
<a class="sourceLine" id="cb8-6" title="6"></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">## User can retain the raw seuList by the following commond.</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">##  PRECASTObj &lt;-  CreatePRECASTObject(seuList, customGenelist=row.names(seuList[[1]]), rawData.preserve = TRUE)</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">## check the number of genes/features after filtering step</span></a>
<a class="sourceLine" id="cb8-10" title="10">PRECASTObj<span class="op">@</span>seulist</a></code></pre></div>
</div>
</div>
<div id="fit-fast-using-simulated-data" class="section level2">
<h2>Fit FAST using simulated data</h2>
<div id="add-the-model-setting" class="section level3">
<h3>Add the model setting</h3>
<p>Add adjacency matrix list and parameter setting of FAST. More model setting parameters can be found in <code>model_set_FAST()</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">## seuList is null since the default value `rawData.preserve` is FALSE.</span></a>
<a class="sourceLine" id="cb9-3" title="3">PRECASTObj<span class="op">@</span>seuList</a>
<a class="sourceLine" id="cb9-4" title="4"></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">## Add adjacency matrix list for a PRECASTObj object to prepare for FAST model fitting.</span></a>
<a class="sourceLine" id="cb9-6" title="6">PRECASTObj &lt;-<span class="st"> </span><span class="kw">AddAdjList</span>(PRECASTObj, <span class="dt">platform =</span> <span class="st">&quot;ST&quot;</span>)</a>
<a class="sourceLine" id="cb9-7" title="7"></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">## Add a model setting in advance for a PRECASTObj object: verbose =TRUE helps outputing the information in the algorithm; </span></a>
<a class="sourceLine" id="cb9-9" title="9">PRECASTObj &lt;-<span class="st"> </span><span class="kw">AddParSettingFAST</span>(PRECASTObj, <span class="dt">verbose=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">## Check the parameters</span></a>
<a class="sourceLine" id="cb9-11" title="11">PRECASTObj<span class="op">@</span>parameterList</a></code></pre></div>
</div>
<div id="fit-fast" class="section level3">
<h3>Fit FAST</h3>
<p>For function <code>FAST</code>, users can specify the number of factors <code>q</code> and the fitted model <code>fit.model</code>. The <code>q</code> sets the number of spatial factors to be extracted, and a lareger one means more information to be extracted but higher computaional cost. The <code>fit.model</code> specifies the version of FAST to be fitted. The Gaussian version (<code>gaussian</code>) models the log-count matrices while the Poisson verion (<code>poisson</code>) models the count matrices; default as <code>poisson</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co">### set q= 20 here</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">set.seed</span>(<span class="dv">2023</span>)</a>
<a class="sourceLine" id="cb10-3" title="3">PRECASTObj &lt;-<span class="st"> </span><span class="kw">FAST</span>(PRECASTObj, <span class="dt">q=</span><span class="dv">20</span>)</a>
<a class="sourceLine" id="cb10-4" title="4"><span class="co">### Check the results</span></a>
<a class="sourceLine" id="cb10-5" title="5"><span class="kw">str</span>(PRECASTObj<span class="op">@</span>resList)</a></code></pre></div>
<details>
<p><summary><strong>Run gaussian version</strong></summary> Users can also use the gaussian version by the following command:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">set.seed</span>(<span class="dv">2023</span>)</a>
<a class="sourceLine" id="cb11-2" title="2">PRECASTObj &lt;-<span class="st"> </span><span class="kw">FAST</span>(PRECASTObj, <span class="dt">q=</span><span class="dv">20</span>, <span class="dt">fit.model=</span><span class="st">&#39;gaussian&#39;</span>)</a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co">### Check the results</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="kw">str</span>(PRECASTObj<span class="op">@</span>resList)</a></code></pre></div>
</details>
</div>
<div id="evaluate-the-adjusted-mcfaddens-pseudo-r-square" class="section level3">
<h3>Evaluate the adjusted McFaddenâs pseudo R-square</h3>
<p>Next, we investigate the performance of dimension reduction by calculating the adjusted McFaddenâs pseudo R-square for each data batch. The simulated true labels is in the <code>meta.data</code> of each component of <code>PRECASTObj@seulist</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co">## Obtain the true labels</span></a>
<a class="sourceLine" id="cb12-2" title="2">yList &lt;-<span class="st"> </span><span class="kw">lapply</span>(PRECASTObj<span class="op">@</span>seulist, <span class="cf">function</span>(x) x<span class="op">$</span>Group)</a>
<a class="sourceLine" id="cb12-3" title="3"><span class="co">### Evaluate the MacR2</span></a>
<a class="sourceLine" id="cb12-4" title="4">MacVec &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(PRECASTObj<span class="op">@</span>seulist), <span class="cf">function</span>(r) <span class="kw">get_r2_mcfadden</span>(PRECASTObj<span class="op">@</span>resList<span class="op">$</span>FAST<span class="op">$</span>hV[[r]], yList[[r]]))</a>
<a class="sourceLine" id="cb12-5" title="5"><span class="co">### output them</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="kw">print</span>(MacVec)</a></code></pre></div>
</div>
</div>
<div id="embedding-alignment-and-clustering-using-harmony-and-louvain" class="section level2">
<h2>Embedding alignment and clustering using Harmony and Louvain</h2>
<p>Based on the embeddings from FAST, we use <code>Harmony</code> to align the embeddings then followed by Louvain clustering to obtain the cluster labels. In this downstream analysis, other methods for embedding alignment and clustering can be also used. In the vignette of two sections of DLPFC Visium data, we will show another method (<code>iSC-MEB</code>) to jointly perform embedding alignment and spatial clustering.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">PRECASTObj &lt;-<span class="st"> </span><span class="kw">RunHarmonyLouvain</span>(PRECASTObj, <span class="dt">resolution =</span> <span class="fl">0.4</span>)</a>
<a class="sourceLine" id="cb13-2" title="2">ARI_vec &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>M, <span class="cf">function</span>(r) mclust<span class="op">::</span><span class="kw">adjustedRandIndex</span>(PRECASTObj<span class="op">@</span>resList<span class="op">$</span>Louvain<span class="op">$</span>cluster[[r]], yList[[r]]))</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">print</span>(ARI_vec)</a></code></pre></div>
</div>
<div id="remove-unwanted-variations-in-the-log-normalized-expression-matrices" class="section level2">
<h2>Remove unwanted variations in the log-normalized expression matrices</h2>
<p>In the following, we remove the unwanted variations in the log-normalized expression matrices to obtain a combined log-normalized expression matrix in a Seurat object. In the context of the simulated data used in this study, housekeeping genes are not present, thus, we turn to another method to remove the unwanted variations. Specifically, we leverage the batch effect embeddings estimated through Harmony to capture and mitigate unwanted variations. Additionally, we utilize the cluster labels obtained via Louvain clustering to retain the desired biological effects.</p>
<p>The estimated embeddings of batch effects (batchEmbed) are in the slot <code>PRECASTObj@resList$Harmony</code> and cluster labels (cluster) are in the slot <code>PRECASTObj@resList$Louvain</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">str</span>(PRECASTObj<span class="op">@</span>resList<span class="op">$</span>Harmony)</a>
<a class="sourceLine" id="cb14-2" title="2"><span class="kw">str</span>(PRECASTObj<span class="op">@</span>resList<span class="op">$</span>Louvain)</a></code></pre></div>
<p>Then, we integrate the three sections by removing the unwanted variations and setting <code>seulist_HK=NULL</code> and <code>Method = &quot;HarmonyLouvain&quot;</code> in the function <code>IntegrateSRTData()</code>. After obtaining <code>seuInt</code>, we will see there are three embeddings: <code>FAST</code>, <code>harmony</code> and <code>position</code>, in the slot <code>seuInt@reductions</code>. <code>FAST</code> are the embeddings obtained by FAST model fitting and are uncorrected embeddings that may includes the unwanted effects (i.e., batch effects); <code>harmony</code>are the embeddings obtained by Harmony fitting and are aligned embeddings; and <code>position</code> are the spatial coordinates.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">seulist_HK &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb15-2" title="2">seuInt &lt;-<span class="st"> </span><span class="kw">IntegrateSRTData</span>(PRECASTObj, <span class="dt">seulist_HK=</span>seulist_HK, <span class="dt">Method =</span> <span class="st">&quot;HarmonyLouvain&quot;</span>, <span class="dt">seuList_raw=</span><span class="ot">NULL</span>, <span class="dt">covariates_use=</span><span class="ot">NULL</span>, <span class="dt">verbose=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb15-3" title="3">seuInt</a></code></pre></div>
</div>
<div id="visualization" class="section level2">
<h2>Visualization</h2>
<p>First, user can choose a beautiful color schema using <code>chooseColors()</code> in the R package <code>PRECAST</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">cols_cluster &lt;-<span class="st"> </span><span class="kw">chooseColors</span>(<span class="dt">palettes_name =</span> <span class="st">&quot;Nature 10&quot;</span>, <span class="dt">n_colors =</span> <span class="dv">7</span>, <span class="dt">plot_colors =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>Then, we plot the spatial scatter plot for clusters using the function <code>SpaPlot()</code> in the R package <code>PRECAST</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">p12 &lt;-<span class="st"> </span><span class="kw">SpaPlot</span>(seuInt, <span class="dt">item =</span> <span class="st">&quot;cluster&quot;</span>, <span class="dt">batch =</span> <span class="ot">NULL</span>, <span class="dt">point_size =</span> <span class="dv">1</span>, <span class="dt">cols =</span> cols_cluster, <span class="dt">combine =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-2" title="2">p12</a></code></pre></div>
<p>Users can re-plot the above figures for specific need by returning a ggplot list object. For example, we plot the spatial heatmap using a common legend by using the function <code>drawFigs()</code> in the R package <code>PRECAST</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">pList &lt;-<span class="st"> </span><span class="kw">SpaPlot</span>(seuInt, <span class="dt">item =</span> <span class="st">&quot;cluster&quot;</span>, <span class="dt">title_name=</span> <span class="st">&#39;Section&#39;</span>,<span class="dt">batch =</span> <span class="ot">NULL</span>, <span class="dt">point_size =</span> <span class="dv">1</span>, <span class="dt">cols =</span> cols_cluster, <span class="dt">combine =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb18-2" title="2"><span class="kw">drawFigs</span>(pList, <span class="dt">layout.dim =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="dt">common.legend =</span> <span class="ot">TRUE</span>, <span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>, <span class="dt">align =</span> <span class="st">&quot;hv&quot;</span>)</a></code></pre></div>
<p>We use the function <code>AddUMAP()</code> in the R package <code>PRECAST</code> to obtain the three-dimensional components of UMAP using the aligned embeddings in the reduction <code>harmony</code>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">seuInt &lt;-<span class="st"> </span><span class="kw">AddUMAP</span>(seuInt, <span class="dt">n_comp=</span><span class="dv">3</span>, <span class="dt">reduction =</span> <span class="st">&#39;harmony&#39;</span>, <span class="dt">assay =</span> <span class="st">&#39;RNA&#39;</span>)</a>
<a class="sourceLine" id="cb19-2" title="2">seuInt</a></code></pre></div>
<p>We plot the spatial tNSE RGB plot to illustrate the performance in extracting features.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">p13 &lt;-<span class="st"> </span><span class="kw">SpaPlot</span>(seuInt, <span class="dt">batch =</span> <span class="ot">NULL</span>, <span class="dt">item =</span> <span class="st">&quot;RGB_UMAP&quot;</span>, <span class="dt">point_size =</span> <span class="dv">1</span>, <span class="dt">combine =</span> <span class="ot">FALSE</span>, <span class="dt">text_size =</span> <span class="dv">15</span>)</a>
<a class="sourceLine" id="cb20-2" title="2"><span class="kw">drawFigs</span>(p13, <span class="dt">layout.dim =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="dt">common.legend =</span> <span class="ot">TRUE</span>, <span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>, <span class="dt">align =</span> <span class="st">&quot;hv&quot;</span>)</a></code></pre></div>
<p>We use the function <code>AddUTSNE()</code> in the R package <code>PRECAST</code> to obtain the two-dimensional components of UMAP using the aligned embeddings in the reduction <code>harmony</code>, and plot the tSNE plot based on the extracted features to check the performance of integration.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">seuInt &lt;-<span class="st"> </span><span class="kw">AddTSNE</span>(seuInt, <span class="dt">n_comp =</span> <span class="dv">2</span>, <span class="dt">reduction =</span> <span class="st">&#39;harmony&#39;</span>, <span class="dt">assay =</span> <span class="st">&#39;RNA&#39;</span>)</a>
<a class="sourceLine" id="cb21-2" title="2">p1 &lt;-<span class="st"> </span><span class="kw">dimPlot</span>(seuInt, <span class="dt">item =</span> <span class="st">&quot;cluster&quot;</span>, <span class="dt">point_size =</span> <span class="fl">0.5</span>, <span class="dt">font_family =</span> <span class="st">&quot;serif&quot;</span>, <span class="dt">cols =</span> cols_cluster,</a>
<a class="sourceLine" id="cb21-3" title="3">    <span class="dt">border_col =</span> <span class="st">&quot;gray10&quot;</span>,  <span class="dt">legend_pos =</span> <span class="st">&quot;right&quot;</span>)  <span class="co"># Times New Roman</span></a>
<a class="sourceLine" id="cb21-4" title="4">p2 &lt;-<span class="st"> </span><span class="kw">dimPlot</span>(seuInt, <span class="dt">item =</span> <span class="st">&quot;batch&quot;</span>, <span class="dt">point_size =</span> <span class="fl">0.5</span>, <span class="dt">font_family =</span> <span class="st">&quot;serif&quot;</span>, <span class="dt">legend_pos =</span> <span class="st">&quot;right&quot;</span>)</a>
<a class="sourceLine" id="cb21-5" title="5"></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="kw">drawFigs</span>(<span class="kw">list</span>(p1, p2), <span class="dt">layout.dim =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>)</a></code></pre></div>
</div>
<div id="combined-differential-epxression-analysis" class="section level2">
<h2>Combined differential epxression analysis</h2>
<p>Finally, we condut the combined differential expression analysis using the integrated log-normalized expression matrix saved in the <code>seuInt</code> object. The function <code>FindAllMarkers()</code> in the <code>Seurat</code> R package is ued to achieve this analysis.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">dat_deg &lt;-<span class="st"> </span><span class="kw">FindAllMarkers</span>(seuInt)</a>
<a class="sourceLine" id="cb22-2" title="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb22-3" title="3">n &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb22-4" title="4">dat_deg <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="st">    </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="st">    </span><span class="kw">top_n</span>(<span class="dt">n =</span> n, <span class="dt">wt =</span> avg_log2FC) -&gt;<span class="st"> </span>top10</a>
<a class="sourceLine" id="cb22-7" title="7">seuInt &lt;-<span class="st"> </span><span class="kw">ScaleData</span>(seuInt)</a></code></pre></div>
<p>Plot dot plot of normalized expressions for each spatial domain identified by using the FAST embeddings.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">col_here &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;#F2E6AB&quot;</span>, <span class="st">&quot;#9C0141&quot;</span>) </a>
<a class="sourceLine" id="cb23-2" title="2"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb23-3" title="3">p1 &lt;-<span class="st"> </span><span class="kw">DotPlot</span>(seuInt, <span class="dt">features=</span><span class="kw">unname</span>(top10<span class="op">$</span>gene), <span class="dt">cols=</span>col_here, <span class="co">#  idents = ident_here,</span></a>
<a class="sourceLine" id="cb23-4" title="4">              <span class="dt">col.min =</span> <span class="dv">-1</span>, <span class="dt">col.max =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_flip</span>()<span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">face =</span> <span class="st">&quot;italic&quot;</span>))<span class="op">+</span></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Domain&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="ot">NULL</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>, <span class="dt">angle =</span> <span class="dv">25</span>, <span class="dt">hjust =</span> <span class="dv">1</span>, <span class="dt">family=</span><span class="st">&#39;serif&#39;</span>),</a>
<a class="sourceLine" id="cb23-6" title="6">                                      <span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>, <span class="dt">face=</span> <span class="st">&quot;italic&quot;</span>, <span class="dt">family=</span><span class="st">&#39;serif&#39;</span>))</a>
<a class="sourceLine" id="cb23-7" title="7">p1</a></code></pre></div>
<details>
<p><summary><strong>Session Info</strong></summary></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="kw">sessionInfo</span>()</a>
<a class="sourceLine" id="cb24-2" title="2"><span class="co">#&gt; R version 4.2.1 (2022-06-23 ucrt)</span></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="co">#&gt; Platform: x86_64-w64-mingw32/x64 (64-bit)</span></a>
<a class="sourceLine" id="cb24-4" title="4"><span class="co">#&gt; Running under: Windows 10 x64 (build 22621)</span></a>
<a class="sourceLine" id="cb24-5" title="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-6" title="6"><span class="co">#&gt; Matrix products: default</span></a>
<a class="sourceLine" id="cb24-7" title="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="co">#&gt; locale:</span></a>
<a class="sourceLine" id="cb24-9" title="9"><span class="co">#&gt; [1] LC_COLLATE=C                               </span></a>
<a class="sourceLine" id="cb24-10" title="10"><span class="co">#&gt; [2] LC_CTYPE=Chinese (Simplified)_China.utf8   </span></a>
<a class="sourceLine" id="cb24-11" title="11"><span class="co">#&gt; [3] LC_MONETARY=Chinese (Simplified)_China.utf8</span></a>
<a class="sourceLine" id="cb24-12" title="12"><span class="co">#&gt; [4] LC_NUMERIC=C                               </span></a>
<a class="sourceLine" id="cb24-13" title="13"><span class="co">#&gt; [5] LC_TIME=Chinese (Simplified)_China.utf8    </span></a>
<a class="sourceLine" id="cb24-14" title="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-15" title="15"><span class="co">#&gt; attached base packages:</span></a>
<a class="sourceLine" id="cb24-16" title="16"><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></a>
<a class="sourceLine" id="cb24-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-18" title="18"><span class="co">#&gt; loaded via a namespace (and not attached):</span></a>
<a class="sourceLine" id="cb24-19" title="19"><span class="co">#&gt;  [1] digest_0.6.33   R6_2.5.1        jsonlite_1.8.7  evaluate_0.21  </span></a>
<a class="sourceLine" id="cb24-20" title="20"><span class="co">#&gt;  [5] cachem_1.0.8    rlang_1.1.1     cli_3.4.1       rstudioapi_0.14</span></a>
<a class="sourceLine" id="cb24-21" title="21"><span class="co">#&gt;  [9] jquerylib_0.1.4 bslib_0.5.0     rmarkdown_2.23  tools_4.2.1    </span></a>
<a class="sourceLine" id="cb24-22" title="22"><span class="co">#&gt; [13] xfun_0.39       yaml_2.3.7      fastmap_1.1.1   compiler_4.2.1 </span></a>
<a class="sourceLine" id="cb24-23" title="23"><span class="co">#&gt; [17] htmltools_0.5.5 knitr_1.43      sass_0.4.7</span></a></code></pre></div>
</details>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
